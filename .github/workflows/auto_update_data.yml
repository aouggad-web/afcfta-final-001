name: Auto Update Data

on:
  # Run daily at 2:00 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - worldbank
          - production
          - trade

permissions:
  contents: write
  actions: read
  pull-requests: write  # required for PR creation

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests openpyxl pandas pymongo
      
      - name: Run data update script
        id: update
        run: |
          echo "Starting data update..."
          python backend/update_data_automated.py
          echo "update_status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Update UN COMTRADE Data
        env:
          COMTRADE_API_KEY: ${{ secrets.COMTRADE_API_KEY }}
          COMTRADE_API_KEY_SECONDARY: ${{ secrets.COMTRADE_API_KEY_SECONDARY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "Updating UN COMTRADE data..."
          python scripts/update_comtrade_data.py
        continue-on-error: true
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet || echo "changes=true" >> $GITHUB_OUTPUT
          git diff --name-only
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(data): automated data update"
          committer: afcfta-data-bot <afcfta-data-bot@users.noreply.github.com>
          author: afcfta-data-bot <afcfta-data-bot@users.noreply.github.com>
          branch: automated-data-update-${{ github.run_number }}
          delete-branch: true
          title: "chore(data): automated data update - run ${{ github.run_number }}"
          body: |
            ## Automated Data Update
            
            This PR contains automated data updates from external sources.
            
            **Run:** #${{ github.run_number }}
            **Workflow:** ${{ github.workflow }}
            **Triggered:** ${{ github.event_name }}
            
            ### Changes
            - Updated World Bank data
            - Updated production data
            - Updated UN COMTRADE data
            
            Please review and merge if all checks pass.
          labels: |
            automated
            data-update
          add-paths: |
            *.json
            *.csv
            *.xlsx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # Exit on any error
          git config user.name "afcfta-data-bot"
          git config user.email "afcfta-data-bot@users.noreply.github.com"
          
          # Add all data files
          git add *.json *.csv *.xlsx 2>/dev/null || true
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(data): automated data update - $(date +'%Y-%m-%d %H:%M UTC')"
            
            # Pull latest changes with rebase to handle concurrent updates
            echo "Syncing with remote main branch..."
            if git pull --rebase origin main; then
              echo "✓ Successfully rebased changes"
            else
              echo "⚠️  Rebase failed, aborting rebase and attempting regular merge"
              git rebase --abort
              git pull --no-rebase origin main  # Will exit if merge fails due to set -e
              echo "✓ Successfully merged changes"
            fi
            
            git push
            echo "✅ Data updated and pushed successfully"
            # Pull and rebase before pushing to handle any remote changes
            echo "Pulling latest changes from remote..."
            git pull --rebase origin main || {
              echo "⚠️ Rebase failed, aborting and falling back to merge strategy..."
              git rebase --abort 2>/dev/null || true
              git pull --no-rebase origin main || {
                echo "❌ Failed to pull remote changes"
                exit 1
              }
            }
            
            # Try to push, retry up to 3 times if it fails
            # Try to push with retries, handling conflicts automatically
            # Try to push with retries
            max_retries=3
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Attempt $((retry_count + 1))/$max_retries to push changes..."
              
              # Pull and rebase before pushing to handle any remote changes
              if git pull --rebase origin main; then
                echo "✓ Successfully rebased on latest changes"
              else
                echo "⚠️ Rebase failed, attempting to resolve conflicts..."
                git rebase --abort 2>/dev/null || true
                
                # Fall back to merge strategy
                if git pull --no-rebase origin main; then
                  echo "✓ Merged with remote changes"
                else
                  echo "❌ Failed to pull remote changes"
                  exit 1
                fi
              fi
              
              # Try to push
              # Pull latest changes before push
              echo "Pulling latest changes from remote..."
              git pull --rebase origin main || {
                echo "⚠️ Rebase failed, aborting and falling back to merge strategy..."
                git rebase --abort 2>/dev/null || true
                git pull --no-rebase origin main || {
                  echo "❌ Failed to pull remote changes"
                  exit 1
                }
              }
              
              # Attempt to push
              if git push; then
                echo "✅ Data updated and pushed successfully"
                break
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "⚠️ Push failed, retrying in 2 seconds..."
                  sleep 2
                else
                  echo "❌ Failed to push after $max_retries attempts"
                  exit 1
                fi
              fi
            done
          fi
      
      - name: Create update summary
        if: always()
        run: |
          echo "## Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add Comtrade API status if available
          if command -v python &> /dev/null; then
            python -c "
            import sys
            import os
            sys.path.insert(0, 'backend')
            try:
                from services.comtrade_service import comtrade_service
                status = comtrade_service.get_service_status()
                print(f'**Comtrade API Status:**')
                print(f'- Active Key: {status[\"current_key\"]}')
                print(f'- Calls Today: {status[\"calls_today\"]}/{status[\"calls_today\"] + status[\"calls_remaining\"]}')
                print(f'- Remaining: {status[\"calls_remaining\"]}')
            except Exception as e:
                print(f'⚠️ Could not get Comtrade status: {e}')
            " >> $GITHUB_STEP_SUMMARY || echo "⚠️ Could not retrieve Comtrade status" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f data_update_report.json ]; then
            echo "### Update Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat data_update_report.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "✅ Data was updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No data changes" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload update report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-update-report-${{ github.run_number }}
          path: |
            data_update_report.json
            worldbank_data_latest.json
          retention-days: 30
